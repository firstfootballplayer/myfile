首先机器人向我发起连接，注册信息有它的id，将id与生成的结构体（其中有本连接fd和前端fd）映射放入到hmap，等待前端请求。通过xml
类型是否注册判断要不要新生成一个结构体
心跳，维护一个固定长度队列，它的类型是hset，hset的类型是包含tcp连接类的弱指针结构体，当连接建立时，用shared新建一个结构体它将tcp连接的
指针赋值给内部的弱指针，然后放入队列的队尾元素中，接着新建weakptr管理新建的结构体sharedptr，将这个weakptr放入tcp连接类中，每当收到新
消息和心跳时通过调用tcp连接类中的weakptr的lock函数，生成新的一个关于结构体的shared将它放入队尾元素中，这样每次收到消息结构体的shareptr
计数会相应增加。定时器函数一秒调用一次，它会将队首出队，然后生成新元素入队，如果在7秒内没有收到新消息，则结构体的sharedptr计数值为0析构，
在析构函数中调用弱指针的lock确认这个连接还在，然后关闭该连接。

前端请求发送机器人控制指令，会带上机器人id，通过id从hmap找到结构体将fd赋值给前端fd（因为是短连接所以每次都要做），在前端的可读
回调里通过id找到对应机器人将控制指令下发，接着在机器人的可读回调中通过id找到前端fd将信息返回给前端然后关闭前端fd。

客户端宕机时，服务端这时向客户端发送数据，服务tcp会持续重传数据，直到超时约9分钟才放弃。

在可读回调发送数据时，因为不同连接采用roundrobin，这个连接不一定在绑定到本线程的epoll中，tcp连接类有它属于的loop类的指针，通过判断
loop类中的线程id和本地线程id是否相同，决定直接发送还是将发送任务推入到从属的loop类的任务队列里面，在唤醒执行。因为写缓冲区
可能满了，暂时无法写入，要判断是否全部发送，如果没有则要关注可写事件，将剩余数据发送出去。要用到epoll的。

内存池类，用模板实现，另一个管理每个对象的结构体，里面有对象指针，是否空闲标志，内存池类指针。内存池类中用一个容器用来放置对象管理
结构体指针，一个容器放置空闲对象在它所属容器中的索引，在构造函数中生成n个结构体及其管理的对象，取对象函数中，先判断空闲个数是否大于0，
如果已经用完则扩容内存池，将空闲索引容器的尾元素出队，返回该索引处的结构体指针，在用完后，调用结构体的放回的函数，将其索引放回空闲索
引容器队列。

tcp在接收消息不一定是一次性接收到全部数据的，可能分多次完成，所以要应用层缓冲区来存放数据，等到完整接收到数据后再进行处理，制定
协议，协议头有数据的长度，来判断是否已经完整接收数据

tcp应用层缓冲区用的vector正常1k，不够时扩容，read函数采用了readv函数有两块缓冲区，额外的一块缓冲区在栈上65536，好处是当数据量很大时
一次读到的数据足够多减少系统调用，当接收图片数据时很大有1m大小，调用resize扩大到1m多（vector自动扩容时乘以2的）
处理完图片数据后恢复缓冲区大小

状态机解析http：主状态机状态： 解析请求行，解析头部字段，处理消息主体。次状态机：字段是否合法。从状态机状态，LINE_OK 完整的一行；LINE_OPEN该行尚未读完；LINE_BAD 该行有错误
主状态机初始状态解析请求行，调用从状态机提取完整一行，如果成功提取则继续解析请求行字段是否合法，解析成功状态改变为解析头部字段，否则返回错误。从状态机被主状态机调用，

2
足够了解业务后，技术上不会有太难的东西，主要是异常的处理比较复杂

相机，可见光红外，变倍聚焦，正负值判断放大缩小停止，设置获取焦距倍数值。云台各个方向，车体运行方向，机器人本体状态（电量，外设开关状态
，避障等报警状态，天气情况温湿度）。任务相关：基本都在数据库里，分层结构，像多叉树，一个任务要巡检n个设备点位，每巡检完一个点位产生一条
巡检结果，接着要上传结果，结果包含设备状态开关，读到仪表数值，是否正常，图片位置，日期，天气等大概20条信息，比如和设备点位相关的多个
信息，设备点位属于设备层次的底层，从主设备分级到2级设备层层往下，所以要根据设备点位层层递进找到它属于的上层设备信息。一些字段上传时要
转换比如巡检状态，数据库里是状态的代号用数字表示，要根据对应的表完成映射，0代表正常，1代表温度异常，2声音异常等等有很多种类需要完成相应
的映射后再上传（针对映射，用哈希表管理所有的情况，用代号做数组下标里面的元素是具体的类型，减少ifelse，提升效率）。


通过线程池工作队列，进行cpu密集型工作，解码图片将其放到指定文件夹

数据结果表越来越大百万级，查询一条要好几秒，进行sql语句优化，使用索引范围。分页法还是在1秒以上

异常：
查找数据库更新后，将结果读出来上传，有时候发现上报的结果中有一个字段是空的，立即检查数据库相应位置发现是有数据的，在日志里看到该字段
确实是空的，（前提是认为只要产生一条新的结果后结果值字段内容一定是有值的，还没得到结果内为什么要更新结果信息，没有和同事确认这个事情）
，看看有没有规律比如任务刚刚启动的时候读不到值，还是在某些特定的设备点对不到，没有发现规律，所以一直在找mysql查询的问题什么情况下可能
读不出来值，没有找到问题，最后和同事确认了，有些字段不一定同时写入值，要过一会才写入。有几个没有及时更新字段值的结果数据将其索引记下，
下次查询时先判断字段有没有更新，在找其他新生成的。

要经常从本机另一个进程获取机器人的状态信息，那个进程可能没有启动，请求超时，返回的xml的值的字段有时候可能是空的，也可能少一个字段。这在解析
或使用该值的时候让程序crash（用一个空值转换成整形会出错，使用了不存在的字段会操作一个非法的内存，），.

有一个接口一直没有响应，经同事确认这个接口成功了不会响应的。










